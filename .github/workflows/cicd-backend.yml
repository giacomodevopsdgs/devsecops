env:
    SYSDIG_SECURE_ENDPOINT: "https://eu1.app.sysdig.com"
    REGISTRY_HOST: "quay.io"
    IMAGE_NAME: "dgsspa/sysdig_test"
    IMAGE_TAG: "tag" 
    DOCKERFILE_CONTEXT: "./cicd"
    REGISTRY_USER: "user"

name: Build and Push Docker Image to GHCR
# on: [push]
on:
  push:
    tags:
      - '*' 
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build and push Docker image
        uses: docker/build-push-action@v5 
        with: 
         context: ./backend
         load: true
         tags: ghcr.io/giacomodevopsdgs/demo_backend:1.0.2 # ToDo: rendere il tag dinamico        
      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: cache
          key: ${{ runner.os }}-cache-${{ hashFiles('**/sysdig-cli-scanner', '**/latest_version.txt', '**/db/main.db.meta.json', '**/scanner-cache/inlineScannerCache.db') }}
          restore-keys: ${{ runner.os }}-cache-
      # - name: Download sysdig-cli-scanner if needed
      #   run:  |
      #     curl -sLO https://download.sysdig.com/scanning/sysdig-cli-scanner/latest_version.txt
      #     mkdir -p ${GITHUB_WORKSPACE}/cache/db/
      #     if [ ! -f ${GITHUB_WORKSPACE}/cache/latest_version.txt ] || [ $(cat ./latest_version.txt) != $(cat ${GITHUB_WORKSPACE}/cache/latest_version.txt) ]; then
      #       cp ./latest_version.txt ${GITHUB_WORKSPACE}/cache/latest_version.txt
      #       curl -sL -o ${GITHUB_WORKSPACE}/cache/sysdig-cli-scanner "https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/$(cat ${GITHUB_WORKSPACE}/cache/latest_version.txt)/linux/amd64/sysdig-cli-scanner"
      #       chmod +x ${GITHUB_WORKSPACE}/cache/sysdig-cli-scanner
      #     else
      #       echo "sysdig-cli-scanner latest version already downloaded"
      #     fi
      # - name: Scan the image using sysdig-cli-scanner
      #   env:
      #     SECURE_API_TOKEN: ${{ secrets.SECURE_API_TOKEN }}
      #   run: |
      #     ${GITHUB_WORKSPACE}/cache/sysdig-cli-scanner \
      #       --apiurl ${SYSDIG_SECURE_ENDPOINT} \
      #       docker://ghcr.io/giacomodevopsdgs/demo_backend:1.0.1 \
      #       --console-log \
      #       --dbpath=${GITHUB_WORKSPACE}/cache/db/ \
      #       --cachepath=${GITHUB_WORKSPACE}/cache/scanner-cache/                
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with: 
          context: ./backend
          push: true
          tags: ghcr.io/giacomodevopsdgs/demo_backend:1.0.2 # ToDo: rendere il tag dinamico
