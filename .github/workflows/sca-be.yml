name: CloudGuard | Shift Left BE

on:
  workflow_dispatch:
jobs:
  get-vbs:
   runs-on: self-hosted
   steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Import Secrets using CyberArk Conjur Secret Fetcher Action
      uses: cyberark/conjur-action@v2.0.5
      with:
        url: https://conjur-cluster.lab
        account: dgsspa
        host_id: host/github-apps
        api_key: ${{ secrets.CONJUR_API_KEY }}
        secrets: CG_API_KEY;CG_API_SECRET;ENVIRONMENT_ID;SPECTRAL_DSN;
        certificate: ${{ secrets.CONJUR_CERTIFICATE }}    
    - name: Set secrets as outputs
      run: |
        echo "::set-output name=CG_API_KEY::$(echo ${{ env.CG_API_KEY }})"
        echo "::set-output name=CG_API_SECRET::$(echo ${{ env.CG_API_SECRET }})"
        echo "::set-output name=ENVIRONMENT_ID::$(echo ${{ env.ENVIRONMENT_ID }})"

  sca-scan:
    name: building image
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Build Docker image
      run: docker build -t backend:latest .
    - name: Save Docker image
      run: docker save backend:latest -o /tmp/backend:latest.tar
    - name: Run the ShiftLeft via docker
      uses: addnab/docker-run-action@v3
      with:
        image: checkpoint/shiftleft:latest_v2
        options: |
          -e CHKP_CLOUDGUARD_ID=${{ needs.get-vbs.outputs.CG_API_KEY }}
          -e CHKP_CLOUDGUARD_SECRET=${{ needs.get-vbs.outputs.CG_API_SECRET }}
          -e SHIFTLEFT_REGION=eu1
          -v /tmp:/tmp        
        run: shiftleft image-scan -e ${{ env.ENVIRONMENT_ID }} -i /tmp/backend:latest.tar
